Tweaking LAMP Settings
======================

###Optimize Apache###

> The values for the following settings are generic values for a server with 
> 512M of RAM. To caluculate, divide the amount of RAM on your server and 
> multiply the result by the values below.
> 
> For example, if your server has 2048M (2G) of RAM, multiply the values below 
> by 4 (`2048 / 512 = 4`).

   $ sudo vi /etc/apache2/apache2.conf

Inside the mpm_prefork_module declaration, set the following values (See note above):

    <IfModule mpm_prefork_module>
      StartServers 1
      MinSpareServers 3
      MaxSpareServers 6
      MaxClients 24
      MaxRequestsPerChild 3000
    </IfModule>

###Optimize MySQL###

    $ sudo vi /etc/mysql/conf.d/drupal.cnf

Add/modify the following lines:
    
    [mysqld]
    query_cache_size = 134217728
    max_connections = 75
    key_buffer = 16M
    max_allowed_packet = 1M
    thread_stack = 64K
    table_cache = 32

> Again, you can tweak these settings according to your specific server and app

Restart MySQL:

    $ sudo service mysql restart

###Optimize PHP###

Install APC

    $ sudo aptitude install php-apc
    $ sudo service apache2 restart

Unzip the APC admin page and create a symlink to it so it can be accessed from
your web app:

    $ sudo gunzip /usr/share/doc/php-apc/apc.php.gz
    $ cd /var/www/vhosts/<path_to_your_web_root>
    $ sudo ln /usr/share/doc/php-apc/apc.php apc.php

Add APC customizations:

    $ sudo vi /etc/php5/apache2/conf.d/apc.ini

Add the following lines below `extension=apc.so`:

    apc.enabled=1
    apc.shm_segments=1
    apc.shm_size=512
    apc.cache_by_default=1
    apc.stat=0
    apc.ttl=0

Restart Apache:

    $ sudo service apache2 restart

We have purposely set APC's available memory to a value larger than will ever 
be used (512M). Now we can see the maximum amount of memory your app can use
by loading every PHP script in your app.

In your browser, visit EVERY PAGE generated by your app. That includes admin
pages - including /admin/build/modules etc for Drupal apps.

Once you're done loading all of the PHP scripts, visit the APC Info page, which
should be accesible at http://yourdomain.com/apc.php if you properly configured
the symlink earlier. Take note of the Used Memory value. You'll want to set the
`apc.shm_size` value (previously set to `512`) to someting higher than Used
Memory value in APC. For example, if Used Memory is is 86.8M, you should set 
your `apc.shm_size` to something like `96M`.

    $ sudo vi /etc/php5/apache2/conf.d/apc.ini

Restart Apache:

    $ sudo service apache2 restart
